<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.edata.monitor.dao.baseinfo.owner.IOwnerDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM user
             A INNER JOIN owner B ON A.ID = B.ID
        WHERE
            (B.OWNERNAME LIKE
             CONCAT('%', #{1}, '%') OR A.PHONE LIKE CONCAT('%', #{1}, '%')) AND
            A.COMPANYID = #{0}
    </select>

    <!-- 删除了user owner 的phone  冲突-->
    <select id="queryPageDetail" resultType="com.edata.monitor.dao.baseinfo.owner.OwnerInfo">
        SELECT
            A.ID,
            A.`ENABLE`,

            A.SERVICESTARTDATE,
            A.SERVICEENDDATE,
            A.CREATETIME,
            A.REMARK,
            B.OWNERNAME,
            B.IDTYPE,
            B.IDNUMBER,


            B.CONTACT,
            B.REGISTRATIONDATE,
            B.PHONE,
            B.FAX,
            B.BUSSINESSAGENT

        FROM user A
            INNER JOIN owner B ON A.ID
                                  = B.ID
        WHERE
            (B.OWNERNAME LIKE CONCAT('%', #{1}, '%') OR A.PHONE
                                                        LIKE
                                                        CONCAT('%', #{1}, '%')) AND A.COMPANYID = #{0}
        LIMIT #{2}, #{3}
    </select>

    <insert id="create" parameterType="com.edata.monitor.dao.baseinfo.owner.Owner">
        INSERT INTO owner (ID,
                           COMPANYID, OWNERNAME, IDTYPE, IDNUMBER,

                           CONTACT,
                           REGISTRATIONDATE,
                           PHONE,
                           FAX,
                           BUSSINESSAGENT) VALUES (#{id}, #{companyId},
                                                   #{ownerName}, #{idType}, #{idNumber}

            , #{CONTACT},
                                                   #{REGISTRATIONDATE},
                                                   #{PHONE},
                                                   #{FAX},
                                                   #{BUSSINESSAGENT}

        )
    </insert>

    <update id="update" parameterType="com.edata.monitor.dao.baseinfo.owner.Owner">
        UPDATE owner
        SET
            COMPANYID        = #{companyId}, OWNERNAME = #{ownerName}, IDTYPE = #{idType},
            IDNUMBER         = #{idNumber},


            CONTACT          = #{CONTACT},
            REGISTRATIONDATE = #{REGISTRATIONDATE},
            PHONE            = #{PHONE},
            FAX              = #{FAX},
            BUSSINESSAGENT   = #{BUSSINESSAGENT}
        WHERE ID = #{id}
              AND EDITTIME = #{editTime}
        LIMIT 1
    </update>

    <delete id="delete">
        DELETE FROM owner
        WHERE ID = #{0}
        LIMIT 1
    </delete>

    <delete id="deleteVehicleInOwner">
        DELETE FROM vehicleinowner
        WHERE OWNERID = #{0}
    </delete>

    <select id="fetch" resultType="com.edata.monitor.dao.baseinfo.owner.Owner">
        SELECT
            ID,
            COMPANYID,
            OWNERNAME,
            IDTYPE,
            IDNUMBER,
            EDITTIME,


            CONTACT,
            REGISTRATIONDATE,
            PHONE,
            FAX,
            BUSSINESSAGENT
        FROM
            owner
        WHERE ID = #{0}
        LIMIT 1
    </select>

    <select id="hasVehicle" resultType="java.lang.Boolean">
        SELECT COUNT(1)
        FROM
            vehicleinowner
        WHERE OWNERID = #{0}
        LIMIT 1
    </select>

    <select id="assignedVehicles" resultType="com.edata.monitor.dao.baseinfo.vehicle.VehicleInfoDto">
        SELECT
            A.ID,
            B.DEVICENUMBER,
            C.PHONENUMBER,
            A.PLATENUMBER,
            A.PLATECOLOR,
            A.INSTALLDATE,
            A.ANNUALSURVEYDATE,
            A.REMARK,
            D.NAME AS
                MOTORCADE
        FROM
            vehicle AS A INNER JOIN device AS B ON A.DEVICEID = B.ID
            INNER JOIN
            simcard AS C ON B.SIMCARDID = C.ID
            INNER JOIN motorcade AS D
                ON
                    A.MOTORCADEID = D.ID
            INNER JOIN vehicleinowner AS E ON
                                               A.ID = E.VEHICLEID
        WHERE E.OWNERID = #{0}
        ORDER BY A.PLATENUMBER
    </select>
    <select id="addVehicles">
        REPLACE INTO vehicleinowner(OWNERID, VEHICLEID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </select>
    <delete id="removeVehicle">
        DELETE FROM vehicleinowner
        WHERE OWNERID = #{0} AND
              VEHICLEID = #{1}
        LIMIT 1
    </delete>
</mapper>
