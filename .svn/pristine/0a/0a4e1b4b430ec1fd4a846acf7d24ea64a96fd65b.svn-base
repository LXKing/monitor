<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.rayton.gps.dao.baseinfo.owner.IOwnerDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM user
        A INNER JOIN automobile_owner B ON A.ID = B.ID
        WHERE
        (B.OWNERNAME LIKE
        CONCAT('%', #{param2}, '%') OR A.PHONE LIKE CONCAT('%', #{param2}, '%')) AND
        A.COMPANYID = #{param1}
    </select>

    <!-- 删除了user automobile_owner 的phone  冲突-->
    <select id="queryPageDetail" resultType="com.rayton.gps.dao.baseinfo.owner.OwnerInfo">
        SELECT
        A.ID,
        A.`ENABLE`,

        A.SERVICESTARTDATE,
        A.SERVICEENDDATE,
        A.CREATETIME,
        A.REMARK,
        B.OWNERNAME,
        B.IDTYPE,
        B.IDNUMBER,


        B.CONTACT,
        B.REGISTRATIONDATE,

        B.FAX,
        B.BUSSINESSAGENT

        FROM user A
        INNER JOIN automobile_owner B ON A.ID
        = B.ID
        WHERE
        (B.OWNERNAME LIKE CONCAT('%', #{param2}, '%') OR A.PHONE
        LIKE
        CONCAT('%', #{param2}, '%')) AND A.COMPANYID = #{param1}
        LIMIT #{param3}, #{param4}
    </select>

    <insert id="create" parameterType="com.rayton.gps.dao.baseinfo.owner.Owner">
        INSERT INTO automobile_owner (ID,
        COMPANYID, OWNERNAME, IDTYPE, IDNUMBER,

        CONTACT,
        REGISTRATIONDATE,

        FAX,
        BUSSINESSAGENT) VALUES (#{id}, #{companyId},
        #{ownerName}, #{idType}, #{idNumber}

        , #{CONTACT},
        #{REGISTRATIONDATE},

        #{FAX},
        #{BUSSINESSAGENT}

        )
    </insert>

    <update id="update" parameterType="com.rayton.gps.dao.baseinfo.owner.Owner">
        UPDATE automobile_owner
        SET
        COMPANYID = #{companyId}, OWNERNAME = #{ownerName}, IDTYPE = #{idType},
        IDNUMBER = #{idNumber},


        CONTACT = #{CONTACT},
        REGISTRATIONDATE = #{REGISTRATIONDATE},

        FAX = #{FAX},
        BUSSINESSAGENT = #{BUSSINESSAGENT}
        WHERE ID = #{id}
        AND EDITTIME = #{editTime}
        LIMIT 1
    </update>

    <delete id="delete">
        DELETE FROM automobile_owner
        WHERE ID = #{param1}
        LIMIT 1
    </delete>

    <delete id="deleteVehicleInOwner">
        DELETE FROM automobile_automobile_owner
        WHERE OWNERID = #{param1}
    </delete>

    <select id="fetch" resultType="com.rayton.gps.dao.baseinfo.owner.Owner">
        SELECT
        ID,
        COMPANYID,
        OWNERNAME,
        IDTYPE,
        IDNUMBER,
        EDITTIME,


        CONTACT,
        REGISTRATIONDATE,

        FAX,
        BUSSINESSAGENT
        FROM
        automobile_owner
        WHERE ID = #{param1}
        LIMIT 1
    </select>

    <select id="hasVehicle" resultType="java.lang.Boolean">
        SELECT COUNT(1)
        FROM
        automobile_automobile_owner
        WHERE OWNERID = #{param1}
        LIMIT 1
    </select>

    <select id="assignedVehicles" resultType="com.rayton.gps.dao.baseinfo.vehicle.VehicleInfoDto">
        SELECT
        A.ID,
        B.DEVICENUMBER,
        C.PHONENUMBER,
        A.PLATENUMBER,
        A.PLATECOLOR,
        A.INSTALLDATE,
        A.ANNUALSURVEYDATE,
        A.REMARK,
        D.NAME AS
        MOTORCADE
        FROM
        automobile AS A INNER JOIN equipment AS B ON A.DEVICEID = B.ID
        INNER JOIN
        simcard AS C ON B.SIMCARDID = C.ID
        INNER JOIN motorcade AS D
        ON
        A.MOTORCADEID = D.ID
        INNER JOIN automobile_automobile_owner AS E ON
        A.ID = E.VEHICLEID
        WHERE E.OWNERID = #{param1}
        ORDER BY A.PLATENUMBER
    </select>
    <select id="addVehicles">
        REPLACE INTO automobile_automobile_owner(OWNERID, VEHICLEID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </select>
    <delete id="removeVehicle">
        DELETE FROM automobile_automobile_owner
        WHERE OWNERID = #{param1} AND
        VEHICLEID = #{param2}
        LIMIT 1
    </delete>
</mapper>
