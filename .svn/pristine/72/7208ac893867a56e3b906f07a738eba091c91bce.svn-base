package com.rayton.gps.service;

import com.rayton.gps.aop.Log;
import com.rayton.gps.dao.baseinfo.MarkerFileInfo;
import com.rayton.gps.util.IconUtil;
import org.apache.shiro.authz.annotation.RequiresPermissions;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.web.multipart.MultipartFile;

import java.io.File;
import java.util.ArrayList;
import java.util.Date;
import java.util.List;

@Service
public class MarkerService {
    @Autowired
    private VehicleService vehicleService;

    public List<MarkerFileInfo> getMarkerFiles(String path) {
        File file = new File(path);
        File[] list = file.listFiles();
        List<MarkerFileInfo> icons = new ArrayList<>();
        for (File icon:list){
            if (icon.isFile()) {
                MarkerFileInfo info = new MarkerFileInfo();
                info.setName(icon.getName());
                Long time = icon.lastModified();
                info.setTime(new Date(time));
                icons.add(info);
            }
        }
        // for (int i = 0; i < list.length; i++) {
        //     File icon = list[i];
        //     if (icon.isFile()) {
        //         MarkerFileInfo info = new MarkerFileInfo();
        //         info.setName(icon.getName());
        //         Long time = icon.lastModified();
        //         info.setTime(new Date(time));
        //         icons.add(info);
        //     }
        // }

        return icons;
    }


    @RequiresPermissions("baseinfo.marker.remove")
    @Log(name = "删除车辆图标")
    public boolean deleteMarkerFile(String path, String name) throws Exception {
        File dest = new File(path, name);
        if (dest.delete()) {
            vehicleService.resetMarker(name, "00.png");
            return true;
        } else
            return false;
    }

    @RequiresPermissions("baseinfo.marker.save")
    @Log(name = "上传车辆图标")
    public void saveMarkerFile(MultipartFile file, String path) throws Exception {
        // String fileName = file.getOriginalFilename().toLowerCase();

        String fileName = IconUtil.uploadPic(path, file);
        // // 检查是否为jpg、png、gif文件
        // if (!fileName.endsWith(".jpg") && !fileName.endsWith(".png") && !fileName.endsWith(".gif")) {
        //     throw new Exception("文件必须为jpg、png、gif类型图像！");
        // }
        //
        // File dest = new File(path, fileName);
        // file.transferTo(dest);
    }
}
