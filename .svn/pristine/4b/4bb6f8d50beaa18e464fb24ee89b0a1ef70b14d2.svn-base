<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.rayton.gps.dao.baseinfo.user.IUserDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM user
        WHERE KIND = 2 AND COMPANYID = #{param1} AND NAME LIKE
        CONCAT('%', #{param2}, '%')
    </select>
    <resultMap type="com.rayton.gps.dao.baseinfo.user.UserInfo"
               id="UserInfoDtoMap">
        <id column="ID" property="id" jdbcType="VARCHAR"/>
        <result column="NAME" property="name" jdbcType="VARCHAR"/>
        <result column="PHONE" property="phone" jdbcType="VARCHAR"/>
        <result column="CREATETIME" property="createTime" jdbcType="TIMESTAMP"/>
        <result column="ENABLE" property="enable" jdbcType="BOOLEAN"/>
        <result column="SERVICESTARTDATE" property="serviceStartDate"
                jdbcType="DATE"/>
        <result column="SERVICEENDDATE" property="serviceEndDate"
                jdbcType="DATE"/>
        <result column="REMARK" property="remark" jdbcType="VARCHAR"/>


        <result column="TEL" property="tel" jdbcType="VARCHAR"/>
        <result column="FAX" property="fax" jdbcType="VARCHAR"/>
        <result column="ZIPCODE" property="zipcode" jdbcType="VARCHAR"/>
        <result column="REGISTERDATE" property="registerDate" jdbcType="DATE"/>
        <result column="SERVICEENDNOTIFYDATE" property="serviceEndNotifyDate" jdbcType="DATE"/>
        <result column="BUSSINESSAGENT" property="bussinessAgent" jdbcType="VARCHAR"/>


    </resultMap>
    <select id="queryPageDetail" resultMap="UserInfoDtoMap">
        SELECT
        ID,
        NAME,
        ENABLE,
        PHONE,
        CREATETIME,
        SERVICESTARTDATE,
        SERVICEENDDATE,
        REMARK,
        TEL,
        FAX,
        ZIPCODE,
        REGISTERDATE,
        SERVICEENDNOTIFYDATE,
        BUSSINESSAGENT
        FROM user
        WHERE
        KIND = 2 AND
        COMPANYID = #{param1} AND
        NAME LIKE CONCAT('%', #{param2}, '%')
        ORDER BY ACCOUNT
        LIMIT #{param3}, #{param4}
    </select>
    <select id="exist" resultType="java.lang.Boolean">
        SELECT COUNT(ID)
        FROM user
        WHERE
        ACCOUNT =
        #{param1}
        LIMIT 1
    </select>
    <select id="existOutId" resultType="java.lang.Boolean">
        SELECT COUNT(ID)
        FROM user
        WHERE
        ACCOUNT = #{param1} AND ID != #{param2}
        LIMIT 1
    </select>
    <insert id="create" parameterType="com.rayton.gps.dao.baseinfo.user.User">
        INSERT INTO
        user (ID, ACCOUNT,
        COMPANYID, KIND, PASSWORD, NAME, EMAIL, PHONE, CONTACT, `ENABLE`,
        SERVICESTARTDATE, SERVICEENDDATE, REMARK, UNID, PID, CREATETIME,
        TEL,
        FAX,
        ZIPCODE,
        REGISTERDATE,
        SERVICEENDNOTIFYDATE,
        BUSSINESSAGENT)
        VALUES (#{id}, #{account}, #{companyId}, #{kind}, #{password}, #{name},
        #{email}, #{phone}, #{contact}, #{enable}, #{serviceStartDate},
        #{serviceEndDate}, #{remark}, UUID(), #{pid}, sysdate(),

        #{tel},
        #{fax},
        #{zipcode},
        #{registerDate},
        #{serviceEndNotifyDate},
        #{bussinessAgent}


        )
    </insert>
    <update id="update" parameterType="com.rayton.gps.dao.baseinfo.user.User">
        UPDATE user
        SET
        ACCOUNT = #{account},
        COMPANYID = #{companyId},
        KIND = #{kind},
        NAME = #{name},
        EMAIL = #{email},
        PHONE = #{phone},
        CONTACT = #{contact},
        `ENABLE` = #{enable},
        SERVICESTARTDATE = #{serviceStartDate},
        SERVICEENDDATE = #{serviceEndDate},
        REMARK = #{remark},

        TEL = #{tel},
        FAX = #{fax},
        ZIPCODE = #{zipcode},
        REGISTERDATE = #{registerDate},
        SERVICEENDNOTIFYDATE = #{serviceEndNotifyDate},
        BUSSINESSAGENT = #{bussinessAgent},

        EDITTIME = #{editTime}
        WHERE ID = #{id}

        LIMIT 1
    </update>
    <delete id="deleteInfo">
        DELETE FROM info
        WHERE USERID = #{param1}
    </delete>
    <delete id="deleteMaplayer">
        DELETE FROM map_layer
        WHERE USERID = #{param1}
    </delete>
    <delete id="deleteTextmessage">
        DELETE FROM text_message
        WHERE USERID = #{param1}
    </delete>
    <delete id="deleteUser">
        DELETE FROM user
        WHERE ID = #{param1}
        LIMIT 1
    </delete>
    <resultMap type="com.rayton.gps.dao.baseinfo.user.User" id="UserDtoMap"
               extends="UserInfoDtoMap">
        <id column="PID" property="pid" jdbcType="VARCHAR"/>
        <result column="COMPANYID" property="companyId" jdbcType="VARCHAR"/>
        <result column="KIND" property="kind" jdbcType="INTEGER"/>
        <result column="ACCOUNT" property="account" jdbcType="VARCHAR"/>
        <result column="EMAIL" property="email" jdbcType="VARCHAR"/>
        <result column="CONTACT" property="contact" jdbcType="VARCHAR"/>
        <result column="EDITTIME" property="editTime" jdbcType="TIMESTAMP"/>


        <result column="TEL" property="tel" jdbcType="VARCHAR"/>
        <result column="FAX" property="fax" jdbcType="VARCHAR"/>
        <result column="ZIPCODE" property="zipcode" jdbcType="VARCHAR"/>
        <result column="REGISTERDATE" property="registerDate" jdbcType="DATE"/>
        <result column="SERVICEENDNOTIFYDATE" property="serviceEndNotifyDate" jdbcType="DATE"/>
        <result column="BUSSINESSAGENT" property="bussinessAgent" jdbcType="VARCHAR"/>


    </resultMap>
    <select id="fetch" resultMap="UserDtoMap">
        SELECT
        ID,
        PID,
        ACCOUNT,
        COMPANYID,
        KIND,
        NAME,
        EMAIL,
        PHONE,
        CONTACT,
        CREATETIME,
        `ENABLE`,
        EDITTIME,
        SERVICESTARTDATE,
        SERVICEENDDATE,
        REMARK,


        TEL,
        FAX,
        ZIPCODE,
        REGISTERDATE,
        SERVICEENDNOTIFYDATE,
        BUSSINESSAGENT
        FROM user
        WHERE ID = #{param1}
        LIMIT
        1
    </select>
    <select id="targetsPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
        (SELECT
        A.ID,
        A.SHORTNAME AS NAME,
        '企业' AS `TYPE`,
        B.REMARK
        FROM
        company AS A INNER JOIN user AS B ON A.ID = B.ID
        WHERE
        B.PID = #{param1}
        UNION
        SELECT
        ID,
        NAME,
        '车队' AS `TYPE`,
        REMARK
        FROM motorcade
        WHERE
        COMPANYID = #{param1}) AS T
        WHERE T.NAME LIKE CONCAT('%', #{param2}, '%')
    </select>
    <select id="targetsPageDetail" resultType="com.rayton.gps.dao.baseinfo.MonitorInfo">
        SELECT *
        FROM (SELECT
        A.ID,
        A.SHORTNAME AS NAME,
        '企业' AS `TYPE`,
        B.REMARK
        FROM company AS A
        INNER JOIN user AS B ON A.ID = B.ID
        WHERE B.PID = #{param1}
        UNION SELECT
        ID,
        NAME,
        '车队' AS `TYPE`,
        REMARK
        FROM motorcade
        WHERE
        COMPANYID = #{param1}) AS T
        WHERE T.NAME LIKE CONCAT('%', #{param2}, '%')
        ORDER BY T.`TYPE`, T.NAME
        LIMIT
        #{param3}, #{param4}
    </select>
    <select id="assignedMonitors" resultType="com.rayton.gps.dao.baseinfo.MonitorInfo">
        SELECT *
        FROM (SELECT
        A.ID,
        A.SHORTNAME AS NAME,
        '企业' AS `TYPE`,
        B.REMARK
        FROM company AS A
        INNER
        JOIN user AS B ON A.ID = B.ID
        WHERE B.PID = #{param2}
        UNION SELECT
        ID,
        NAME,
        '车队' AS `TYPE`,
        REMARK
        FROM motorcade
        WHERE
        COMPANYID = #{param2}) AS T
        INNER
        JOIN user_monitor AS M ON T.ID = M.TARGETID
        WHERE M.USERID = #{param1}
        ORDER BY
        T.`TYPE`, T.NAME
    </select>
    <select id="addMonitors">
        REPLACE INTO user_monitor(USERID, TARGETID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </select>
    <delete id="removeMonitor">
        DELETE FROM user_monitor
        WHERE USERID = #{param1} AND
        TARGETID = #{param2}
        LIMIT 1
    </delete>
    <select id="assignedRoles" resultType="com.rayton.gps.dao.baseinfo.role.Role">
        SELECT
        A.ID,
        A.NAME,
        A.REMARK
        FROM role AS A INNER JOIN user_role AS B ON
        A.ID = B.ROLEID
        WHERE B.USERID = #{param1}
    </select>
    <select id="addRoles">
        REPLACE INTO user_role(USERID, ROLEID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </select>
    <delete id="removeRole">
        DELETE FROM user_role
        WHERE USERID = #{param1} AND
        ROLEID = #{param2}
        LIMIT 1
    </delete>
    <select id="getUserOptions" resultType="java.lang.String">
        SELECT USERVALUE
        FROM
        user_setting
        WHERE USERID = #{param1} AND USERKEY = #{param2}
        LIMIT 1
    </select>
    <insert id="saveUserOptions">
        REPLACE INTO user_setting (USERID, USERKEY, USERVALUE)
        VALUES (#{param1}, #{param2}, #{param3})
    </insert>
</mapper>