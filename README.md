# doc

标签（空格分隔）： 未分类

---

由三部分组成，包括Gateway网关连接层，Logic数据处理层、Web监控调度端。  

- 网关连接层负责GPS终端的接入，维护TCP长连接及心跳，接收终端发送的信息，转发到数据处理层进行处理，数据处理层也可通过MQ消息队列将指令发到网关，由网关下发到终端设备。

- 数据处理层接收Gateway网关通过HTTP转发过来的数据进行处理，是系统中的主要部分，负责用户的认证、在线状态、处理设备登录、GPS、定位、轨迹、报警、指令等功能，也可进行负载均衡处理。

- 监控调度端是用户直接接触的平台，通过HTTP访问数据处理层，获取车辆上下线，GPS定位、轨迹、报警信息，进行下发指令等操作，提供账号及权限管理。

---

流程：
 
- 设备上传信息：设备 ==> TCP长连接 ==> Gateway(Mina连接层) ==> HTTP访问 ==> 逻辑后台 ==> 数据库（逻辑后台）

- 用户对终端下发命令：用户 ==> Web监控调度端 ==> HTTP访问 ==> 逻辑后台 ==> 发送指令 ==> 消息队列服务 ==> 推送 ==> Gateway(Mina连接层) ==> TCP长连接 ==> 设备


---

架构：

* doc：协议文档等。

* gps_common：一些工具类。

* gps_domain：一些通用的实体类。

* gps_gateway：网关。
    * 大量用到了反射（初始化时）。
    * 通过`XML`的配置反射初始化启动多个`Server`（协议不同，连接方式不同，`TCP`或`UDP`）。
    * 开启`MQ`，接受逻辑层发过来的指令，并通过字典里保存的`IOSession`将指令下发给连接的设备。
    * 以某个`JTT808`协议的`TcpServer`为例：
        * 添加`Decoder`，将网络字节流根据标识位打包成协议包字节（因为`TCP`是流，多个协议包可能连在一起）。
        * Mina的`messageReceived`方法就可以收到打包的字节流了，调用`Util`的`antisense`方法将转义还原，并实例化一个`Packet`，将字节填充进去，调用实例的`from`方法初始化`Packet`的基本数据。
        * 通过`RawDataParser`字典，根据协议类型的键值取出对应的解析器（初始化：通过反射实例化`codec`包下所有实现了`IRawDataParser`这个接口的类） 。
        * 调用`Parser`的`parse`方法，`Parser`有一个`CommandHandler`的字典，保存了该协议下的不同指令`Handler`。
        * 通过`Packet`的`Command`作为键值取出`Handler`（初始化：通过反射实例化`Handler`包下所有实现了`ICommandHandler`这个接口的类）。
        * 调用该`Handler`的`process`方法，做对应的处理，实例化一个`Packet`，该干嘛干嘛，调用实例的`array`方法转为符合格式的字节流发出去。
        * 以上操作因为都调用的是`NIO`的`Buffer`缓冲，所以效率还是不差的。
    * 注意如果是使用`UDP`协议的话要在应用层做额外的维护，比如心跳，毕竟是丢了不管的。
    * (￢︿̫̿￢☆)，写这么多废话是因得这部分代码是很值得学习的，比如用反射初始化，一些设计模式，还有`NIO`的处理等。

* gps_logic：逻辑处理。
    * 这里也大量使用了反射初始化，不说了。
    * `Gateway`==>`Logic`是通过`HTTP`直接`POST`过来的，但是`Logic`==>`Gateway`是通过`MQ`推过去的。
    * `Logic`==>`Web`也是通过`HTTP`直接`POST`过去，`Web`==>`Logic`也是`POST`，`Web`后台请求数据时，带上参数和调用的方法名，再通过反射调用有该注解的`Component`。
    
* gps_protocol：传输协议包的定义。
    * `gbt19056`：汽车记录仪协议。
    * `jtt808`：部标808协议。
        * 协议格式：标识位 - 消息头 - 消息体 - 检验码 - 标识位。
        * 采用大端模式(`big-endian`)的网络字节序来传递字和双字（基本都是默认的）
            * 字节(`BYTE`，无符号单字节整型，`8` 位)：按照字节流的方式传输；
            * 字(`WORD`，无符号双字节整型，`16` 位)：先传递高 `8` 位，再传递低 `8` 位；
            * 双字(`DWORD`，无符号四字节整型，`32` 位)：先传递高 `24` 位，然后传递高 `16` 位，再传递高 `8` 位，最后传递低 `8` 位。
        * 标识位： `0x7e`，若校验码、消息头以及消息体中出现 `0x7e`，要转义。
    * `kangkaisi`：某深圳厂家的私有协议。
        * 协议格式：起始位 - 包长度 - 协议号 - 信息内容 - 信息序列号 - 错误校验 - 停止位。
        * 由于有包长度，不需要转义了，编解码也比较简单。

* gps_web：后台监控管理，用`SpringBoot`包了一层，没什么说的。`Shiro`权限管理。


---

其他：

删了一些东西，后台`MyBatis`的映射文件包名要修改，仅作学习用途。

