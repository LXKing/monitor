<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mmp.gps.monitor.dao.baseinfo.sim.ISimcardDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
            simcard
        WHERE COMPANYID = #{param1}
          AND (SIMCARDNUMBER LIKE
               CONCAT('%', #{param2}, '%') OR
               CARRIEROPERATOR LIKE CONCAT('%', #{param2}, '%') OR
               PHONENUMBER LIKE CONCAT('%', #{param2}, '%'))
    </select>
    <select id="queryPageDetail" resultType="mmp.gps.monitor.dao.baseinfo.sim.Simcard">
        SELECT
            simcard.ID,
            simcard.PHONENUMBER       as phoneNumber,
            simcard.SIMCARDNUMBER     as simcardNumber,
            simcard.PURCHASEDATE      as purchaseDate,
            simcard.CARRIEROPERATOR   as carrierOperator,
            simcard.PREPAYMENT        as prepayment,
            simcard.EXPIREDATE        as expireDate,
            simcard.CREATETIME        as createTime,
            simcard.REMARK            as remark,
            simcard.ACCOUNTNAME       as accountName,
            simcard.MONTHLYRENT       as monthlyrent,
            simcard.INSTOCKDATE       as instockDate,
            simcard.OUTSTOCKDATE      as outstockDate,
            simcard.EXPIRENOTIFYDATE  as expirenotifyDate,
            equipment.DEVICENUMBER    as equid,
            simcard.EQUIPMENTBINDDATE as equtpmentbindDate,
            simcard.ICCID             as iccid,
            simcard.MISDN             as misdn
        FROM
            simcard
                LEFT JOIN equipment on equipment.SIMCARDID = simcard.ID
        WHERE
            simcard.COMPANYID = #{param1}
          AND (simcard.SIMCARDNUMBER
                   LIKE CONCAT('%', #{param2}, '%') OR
               simcard.CARRIEROPERATOR LIKE CONCAT('%', #{param2}, '%')
            OR simcard.PHONENUMBER LIKE
               CONCAT('%', #{param2}, '%'))
        ORDER BY simcard.PHONENUMBER
                 LIMIT
                 #{param3}, #{param4}
    </select>
    <insert id="create" parameterType="mmp.gps.monitor.dao.baseinfo.sim.Simcard">
        INSERT INTO simcard (ID,
                             COMPANYID, PHONENUMBER, SIMCARDNUMBER, SPEECHTYPE,
                             OPENSMS, OPENDATE,
                             PURCHASEDATE, CARRIEROPERATOR, PREPAYMENT,
                             EXPIREDATE, FLOWSET,
                             CREATETIME, REMARK,
                             ACCOUNTNAME,
                             MONTHLYRENT,
                             INSTOCKDATE,
                             OUTSTOCKDATE,
                             EXPIRENOTIFYDATE,
                             ICCID,
                             MISDN,
                             SIMSTATE)
        VALUES (#{id}, #{companyId}, #{phoneNumber},
                #{simcardNumber}, #{speechType}, #{openSMS},
                #{openDate},
                #{purchaseDate}, #{carrierOperator}, #{prepayment},
                #{expireDate},
                #{flowset}, SYSDATE(), #{remark},
                #{accountName},
                #{monthlyrent},
                #{instockDate},
                #{outstockDate},
                #{expirenotifyDate},
                #{iccid},
                #{misdn},
                #{simState})
    </insert>
    <update id="update" parameterType="mmp.gps.monitor.dao.baseinfo.sim.Simcard">
        UPDATE simcard
        SET COMPANYID        = #{companyId},
            PHONENUMBER      = #{phoneNumber},
            SIMCARDNUMBER    = #{simcardNumber},
            SPEECHTYPE       = #{speechType},
            OPENSMS          = #{openSMS},
            OPENDATE         = #{openDate},
            PURCHASEDATE     = #{purchaseDate},
            CARRIEROPERATOR  = #{carrierOperator},
            PREPAYMENT       = #{prepayment},
            EXPIREDATE       = #{expireDate},
            FLOWSET          = #{flowset},
            REMARK           = #{remark},
            ACCOUNTNAME      = #{accountName},
            MONTHLYRENT      = #{monthlyrent},
            INSTOCKDATE      = #{instockDate},
            OUTSTOCKDATE     = #{outstockDate},
            EXPIRENOTIFYDATE = #{expirenotifyDate},
            EDITTIME         = #{editTime},
            ICCID            = #{iccid},
            MISDN            = #{misdn},
            SIMSTATE         = #{simState}
        WHERE
            ID = #{id}
            LIMIT 1
    </update>
    <select id="assignedDevice" resultType="java.lang.String">
        SELECT DEVICENUMBER
        FROM
            equipment
        WHERE SIMCARDID = #{param1}
            LIMIT 1
    </select>
    <delete id="delete">
        DELETE
        FROM simcard
        WHERE ID = #{param1}
    </delete>
    <select id="fetch" resultType="mmp.gps.monitor.dao.baseinfo.sim.Simcard">
        SELECT
            simcard.ID,
            simcard.COMPANYID,
            simcard.PHONENUMBER,
            simcard.SIMCARDNUMBER,
            simcard.SPEECHTYPE,
            simcard.OPENSMS,
            simcard.OPENDATE,
            simcard.PURCHASEDATE,
            simcard.CARRIEROPERATOR,
            simcard.PREPAYMENT,
            simcard.EXPIREDATE,
            simcard.FLOWSET,
            simcard.CREATETIME,
            simcard.REMARK,
            simcard.EDITTIME,
            simcard.ACCOUNTNAME,
            simcard.MONTHLYRENT,
            simcard.INSTOCKDATE,
            simcard.OUTSTOCKDATE,
            simcard.EXPIRENOTIFYDATE,
            simcard.ICCID,
            simcard.MISDN,
            equipment.id AS equid,
            simcard.EQUIPMENTBINDDATE
        FROM
            simcard
                LEFT JOIN equipment ON equipment.SIMCARDID = simcard.ID
        WHERE
            simcard.ID = #{param1}
            LIMIT 1
    </select>
    <select id="exist" resultType="java.lang.Boolean">
        SELECT COUNT(1)
        FROM simcard
        WHERE
            ICCID = #{param1}
            LIMIT 1
    </select>
    <select id="existOutId" resultType="java.lang.Boolean">
        SELECT COUNT(1)
        FROM simcard
        WHERE ICCID = #{param1}
          AND ID != #{param2}
            LIMIT 1
    </select>
    <select id="searchPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
            simcard
        WHERE COMPANYID = #{param1}
          AND
                PHONENUMBER LIKE
                CONCAT('%', #{param2}, '%')
    </select>
    <select id="searchPageDetail" resultType="mmp.gps.monitor.dao.baseinfo.sim.SimcardSearchInfo">
        SELECT
            ID,
            PHONENUMBER,
            SPEECHTYPE,
            OPENSMS,
            CARRIEROPERATOR,
            REMARK,
            ACCOUNTNAME,
            MONTHLYRENT,
            INSTOCKDATE,
            OUTSTOCKDATE,
            EXPIRENOTIFYDATE
        FROM
            simcard
        WHERE
            COMPANYID = #{param1}
          AND PHONENUMBER LIKE CONCAT('%', #{param2}, '%')
        ORDER BY
            SIMCARDNUMBER
            LIMIT #{param3}, #{param4}
    </select>
    <select id="freePageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
            simcard
        WHERE ID NOT IN (SELECT SIMCARDID
                         FROM equipment
                         WHERE
                             COMPANYID = #{param1})
          AND COMPANYID = #{param1}
          AND PHONENUMBER LIKE
              CONCAT('%', #{param2}, '%')
    </select>
    <select id="freePageDetail" resultType="mmp.gps.monitor.dao.baseinfo.sim.SimcardSearchInfo">
        SELECT
            ID,
            PHONENUMBER,
            SPEECHTYPE,
            OPENSMS,
            CARRIEROPERATOR,
            REMARK,
            ACCOUNTNAME,
            MONTHLYRENT,
            INSTOCKDATE,
            OUTSTOCKDATE,
            EXPIRENOTIFYDATE
        FROM
            simcard
        WHERE ID NOT
            IN (SELECT SIMCARDID
                FROM equipment
                WHERE
                    COMPANYID = #{param1})
          AND
            COMPANYID = #{param1}
          AND PHONENUMBER LIKE CONCAT('%', #{param2}, '%')
        ORDER BY
            SIMCARDNUMBER
            LIMIT #{param3}, #{param4}
    </select>

    <select id="selectSIMcard" resultType="mmp.gps.monitor.dao.baseinfo.sim.Simcard">
        SELECT *
        FROM
            simcard
        WHERE ID NOT IN (SELECT SIMCARDID
                         FROM equipment)
          AND COMPANYID = #{param1}
    </select>

    <select id="groupShit" resultType="java.lang.String">

        SELECT s.PHONENUMBER
        FROM equipment e,
             simcard s
        WHERE e.DEVICENUMBER = #{param1}
          AND s.ID = e.SIMCARDID


    </select>

</mapper>
