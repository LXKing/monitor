<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="mmp.gps.monitor.dao.baseinfo.company.ICompanyDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM user A
                 INNER JOIN company B ON A.ID = B.ID
        WHERE
            (B.FULLNAME LIKE
             CONCAT('%', #{param2}, '%') OR
             B.SHORTNAME LIKE CONCAT('%', #{param2}, '%'))
          AND
            A.PID = #{param1}
    </select>
    <select id="queryPageDetail" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">
        SELECT
            B.ID            AS id,
            A.PID           AS pId,
            B.FULLNAME      AS fullName,
            B.OFFICEADDRESS AS officeAddress,
            A.PHONE         AS phone,
            A.CONTACT       AS contact,
            B.ONDUTYPHONE   AS ondutyphone,
            A.EMAIL         AS email,
            A.REGISTERDATE  AS registdate
        FROM user A
                 INNER JOIN company B ON A.ID = B.ID
        WHERE (B.FULLNAME LIKE CONCAT('%', #{param2}, '%') OR B.SHORTNAME LIKE CONCAT('%', #{param2}, '%'))
          AND
            (A.PID = #{param1})
            LIMIT #{param3}
            , #{param4}
    </select>

    <select id="queryPageDetails" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">
        SELECT
            B.ID            AS id,
            A.PID           AS pId,
            B.FULLNAME      AS fullName,
            B.OFFICEADDRESS AS officeAddress,
            A.PHONE         AS phone,
            A.CONTACT       AS contact,
            B.ONDUTYPHONE   AS ondutyphone,
            A.EMAIL         AS email,
            A.REGISTERDATE  AS registdate
        FROM user A
                 INNER JOIN company B ON A.ID = B.ID
        WHERE (B.FULLNAME LIKE CONCAT('%', #{param2}, '%') OR B.SHORTNAME LIKE CONCAT('%', #{param2}, '%'))
          AND
            ISNULL(A.PID = #{param1})
            LIMIT #{param3}
            , #{param4}
    </select>

    <insert id="create" parameterType="mmp.gps.monitor.dao.baseinfo.company.Company">
        INSERT INTO company (ID,
                             FULLNAME, SHORTNAME, ORGANCODE, REGISTDATE,
                             CORPORATION, ONDUTYPHONE,
                             OFFICEADDRESS, REGISTADDRESS, PARENTVISIBLE, FAX, EMAIL, ZIPCODE)
        VALUES (#{id},
                #{fullName}, #{shortName}, #{organCode}, #{registDate},
                #{corporation}, #{ondutyPhone}, #{officeAddress}, #{registAddress},
                #{parentVisible},
                #{FAX},
                #{EMAIL},
                #{ZIPCODE})
    </insert>

    <insert id="createAdminRole" parameterType="mmp.gps.monitor.dao.baseinfo.role.Role">
        INSERT INTO role (ID,
                          COMPANYID, NAME, REMARK)
        VALUES (#{id}, #{companyId}, #{name},
                #{remark})
    </insert>

    <insert id="assignAdminRole">
        INSERT INTO user_role (USERID, ROLEID)
        VALUES (#{param1},
                #{param2})
    </insert>
    <select id="fetch" resultType="mmp.gps.monitor.dao.baseinfo.company.Company">
        SELECT
            ID,
            FULLNAME,
            SHORTNAME,
            ORGANCODE,
            CORPORATION,
            ONDUTYPHONE,
            OFFICEADDRESS,
            EDITTIME,
            REGISTDATE,
            FAX,
            EMAIL,
            ZIPCODE,
            REGISTADDRESS,
            PARENTVISIBLE
        FROM
            company
        WHERE ID = #{param1}
            LIMIT 1
    </select>

    <update id="update" parameterType="mmp.gps.monitor.dao.baseinfo.company.Company">
        UPDATE company
        SET
            FULLNAME      =
                #{fullName},
            SHORTNAME     = #{shortName},
            ORGANCODE     =
                #{organCode},
            REGISTDATE    =
                #{registDate},
            CORPORATION   = #{corporation},
            ONDUTYPHONE   =
                #{ondutyPhone},
            OFFICEADDRESS = #{officeAddress},
            REGISTADDRESS
                          =
                #{registAddress},
            PARENTVISIBLE = #{parentVisible},
            EDITTIME      = #{editTime},
            FAX           = #{FAX},
            EMAIL         = #{EMAIL},
            ZIPCODE       = #{ZIPCODE}

        WHERE ID = #{id}

            LIMIT 1
    </update>

    <delete id="deleteCircle">DELETE
                              FROM circle_region
                              WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteDevice">DELETE
                              FROM equipment
                              WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteDriver">DELETE
                              FROM driver
                              WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteLog">DELETE
                           FROM log
                           WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteMaintain">DELETE
                                FROM maintain
                                WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteMaplayer">DELETE
                                FROM map_layer
                                WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteMotorcade">DELETE
                                 FROM motorcade
                                 WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteOwner">DELETE
                             FROM automobile_owner
                             WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deletePoi">DELETE
                           FROM point_of_interest
                           WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deletePolygon">DELETE
                               FROM polygon_region
                               WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteRectangle">DELETE
                                 FROM rectangle_region
                                 WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteRole">DELETE
                            FROM role
                            WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteRoleinuser">DELETE
                                  FROM user_role
                                  WHERE USERID = #{param1}
    </delete>
    <delete id="deleteRoleauthorize">DELETE
                                     FROM role_permission
                                     WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteRoute">DELETE
                             FROM route
                             WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteSimcard">DELETE
                               FROM simcard
                               WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteVehicle">DELETE
                               FROM automobile
                               WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteCompany">DELETE
                               FROM company
                               WHERE ID = #{param1}
                                   LIMIT 1
    </delete>
    <delete id="deleteCompanyauthorize">DELETE
                                        FROM company_permission
                                        WHERE COMPANYID = #{param1}
    </delete>
    <delete id="deleteUser">DELETE
                            FROM user
                            WHERE COMPANYID = #{param1}
    </delete>

    <delete id="deleteAdminAuthorize">DELETE
                                      FROM role_permission
                                      WHERE ROLEID = #{param1}
    </delete>

    <select id="authorizes" resultType="java.lang.String">
        SELECT PERMISSIONID
        FROM
            company_permission
        WHERE COMPANYID = #{param1}
    </select>
    <select id="assignCompanyAuthorize">
        INSERT INTO company_permission(COMPANYID, PERMISSIONID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </select>
    <select id="assingAdminAuthorize">
        INSERT INTO role_permission(COMPANYID, ROLEID, PERMISSIONID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.key},#{item.value})
        </foreach>
    </select>
    <delete id="cleanRoleauthorize">
        DELETE
        FROM role_permission
        WHERE COMPANYID = #{param1}
          AND
                PERMISSIONID NOT IN (SELECT PERMISSIONID
                                     FROM company_permission
                                     WHERE
                                         COMPANYID = #{param1})
    </delete>

    <select id="hasSub">SELECT 1
                        FROM user
                        WHERE PID = #{param1}
                            LIMIT 1
    </select>
    <select id="getSub" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">


        SELECT
            B.ID       AS id,
            A.PID      AS pId,
            B.FULLNAME AS fullName

        FROM user A
                 INNER JOIN company B ON A.COMPANYID = B.ID
                AND (A.PID = #{param1})

        UNION
        SELECT
            ID   AS id,
            COMPANYID
                 AS pId,
            NAME AS fullName

        FROM motorcade
        WHERE
            COMPANYID = #{param1}

    </select>

    <select id="getSup" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">

        SELECT
            B.ID       AS id,
            A.PID      AS pId,
            B.FULLNAME AS fullName

        FROM user A
                 INNER JOIN company B ON A.PID = B.ID
                AND (A.COMPANYID = #{param1})


    </select>
    <select id="getCur" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">
        SELECT
            ID       AS id,
            FULLNAME AS fullName
        FROM
            company
        WHERE ID = #{param1}

    </select>

    <insert id="createPermission" parameterType="mmp.gps.monitor.dao.security.Permission">
        INSERT INTO company_permission (COMPANYID, PERMISSIONID, name, pid)
        VALUES (#{COMPANYID}, #{id}, #{name}, #{pid})
    </insert>
    <delete id="deletePermission" parameterType="mmp.gps.monitor.dao.security.Permission">
        DELETE
        FROM company_permission
        WHERE PERMISSIONID = #{id}
    </delete>


    <update id="updatePermission" parameterType="mmp.gps.monitor.dao.security.Permission">
        UPDATE company_permission
        SET COMPANYID    = #{COMPANYID},
            PERMISSIONID = #{id},
            name         = #{name},
            pid          = #{pid}
    </update>

    <select id="getCompanyByPid" resultType="mmp.gps.monitor.dao.baseinfo.company.CompanyInfoVo">
        SELECT
            B.ID       AS id,
            A.PID      AS pId,
            B.FULLNAME AS fullName
        FROM
            user A
                INNER JOIN company B ON A.COMPANYID = B.ID AND A.PID = #{param1}


    </select>


</mapper>
