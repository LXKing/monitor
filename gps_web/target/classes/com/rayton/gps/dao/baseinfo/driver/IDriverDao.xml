<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.rayton.gps.dao.baseinfo.driver.IDriverDao">
    <select id="queryPageCount" resultType="java.lang.Integer">
        SELECT COUNT(1)
        FROM
        driver
        WHERE (NAME LIKE CONCAT('%', #{1}, '%') OR PHONE LIKE
        CONCAT('%', #{1}, '%') OR
        DRIVINGLICENSENUMBER LIKE CONCAT('%', #{1}, '%'))
        AND COMPANYID = #{0}
    </select>
    <select id="queryPageDetail" resultType="com.rayton.gps.dao.baseinfo.driver.DriverInfo">
        SELECT
        ID,
        NAME,
        SEX,
        PHONE,
        DRIVINGLICENSENUMBER,
        REMARK,

        REGISTRATIONDATE,
        PERMITCODE,
        EMERGENCYCONTACTA,
        EMERGENCYCONTACTB


        FROM driver
        WHERE
        (NAME LIKE
        CONCAT('%', #{1}, '%') OR PHONE LIKE CONCAT('%', #{1}, '%') OR
        DRIVINGLICENSENUMBER LIKE CONCAT('%', #{1}, '%')) AND
        COMPANYID = #{0}
        LIMIT #{2}, #{3}
    </select>
    <insert id="create" parameterType="com.rayton.gps.dao.baseinfo.driver.Driver">
        INSERT INTO driver (ID,
        COMPANYID, NAME, SEX, PHONE, IDTYPE, IDNUMBER,
        DRIVINGLICENSENUMBER,
        REMARK, DRIVINGLICENSEEXPIRYDATE,

        REGISTRATIONDATE,
        PERMITCODE,
        EMERGENCYCONTACTA,
        EMERGENCYCONTACTB

        ) VALUES (
        #{id}, #{companyId},
        #{name}, #{sex}, #{phone}, #{idType}, #{idNumber},
        #{drivingLicenseNumber}, #{remark}, #{drivingLicenseExpiryDate},

        #{REGISTRATIONDATE},
        #{PERMITCODE},
        #{EMERGENCYCONTACTA},
        #{EMERGENCYCONTACTB}


        )
    </insert>
    <update id="update" parameterType="com.rayton.gps.dao.baseinfo.driver.Driver">
        UPDATE driver
        SET
        COMPANYID = #{companyId}, NAME = #{name}, SEX = #{sex}, PHONE = #{phone},
        IDTYPE = #{idType}, IDNUMBER = #{idNumber},
        DRIVINGLICENSENUMBER = #{drivingLicenseNumber}, REMARK = #{remark},
        DRIVINGLICENSEEXPIRYDATE = #{drivingLicenseExpiryDate},


        REGISTRATIONDATE = #{REGISTRATIONDATE},
        PERMITCODE = #{PERMITCODE},
        EMERGENCYCONTACTA = #{EMERGENCYCONTACTA},
        EMERGENCYCONTACTB = #{EMERGENCYCONTACTB}

        WHERE ID = #{id} AND
        EDITTIME = #{editTime}
        LIMIT 1
    </update>
    <delete id="deleteVehicleInDriver">
        DELETE FROM vehicleindriver
        WHERE DRIVERID = #{0}
    </delete>
    <delete id="delete">
        DELETE FROM driver
        WHERE ID = #{0}
        LIMIT 1
    </delete>
    <select id="fetch" resultType="com.rayton.gps.dao.baseinfo.driver.Driver">
        SELECT
        ID,
        COMPANYID,
        NAME,
        SEX,
        PHONE,
        IDTYPE,
        IDNUMBER,
        DRIVINGLICENSENUMBER,
        REMARK,
        EDITTIME,
        DRIVINGLICENSEEXPIRYDATE,


        REGISTRATIONDATE,
        PERMITCODE,
        EMERGENCYCONTACTA,
        EMERGENCYCONTACTB
        FROM driver
        WHERE ID = #{0}
        LIMIT 1
    </select>
    <select id="assignedVehicles" resultType="com.rayton.gps.dao.baseinfo.vehicle.VehicleInfoDto">
        SELECT
        A.ID,
        B.DEVICENUMBER,
        C.PHONENUMBER,
        A.PLATENUMBER,
        A.PLATECOLOR,
        A.INSTALLDATE,
        A.ANNUALSURVEYDATE,
        A.REMARK,
        D.NAME AS
        MOTORCADE
        FROM
        vehicle AS A INNER JOIN device AS B ON A.DEVICEID = B.ID
        INNER JOIN
        simcard AS C ON B.SIMCARDID = C.ID
        INNER JOIN motorcade AS D
        ON
        A.MOTORCADEID = D.ID
        INNER JOIN vehicleindriver AS E ON
        A.ID = E.VEHICLEID
        WHERE E.DRIVERID = #{0}
        ORDER BY A.PLATENUMBER
    </select>

    <insert id="addVehicles">
        REPLACE INTO vehicleindriver(DRIVERID, VEHICLEID) VALUES
        <foreach collection="list" item="item" separator=",">
            (#{item.key},#{item.value})
        </foreach>
    </insert>
    <delete id="removeVehicle">
        DELETE FROM vehicleindriver
        WHERE DRIVERID = #{0} AND
        VEHICLEID = #{1}
        LIMIT 1
    </delete>
</mapper>